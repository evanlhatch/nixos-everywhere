runcmd:
  - |
    # Export environment variables for nixos-everywhere.sh
    export FLAKE_URI_INPUT="${NIXOS_FLAKE_URI}#${NIXOS_FLAKE_HOST_ATTR}"
    export SSH_AUTHORIZED_KEYS_INPUT="${SSH_AUTHORIZED_KEYS_CONTENT}"
    export NIXOS_CHANNEL_ENV="${NIXOS_CHANNEL_ENV}"
    export HOSTNAME_INIT_ENV="${HOSTNAME_INIT_ENV}"
    export TIMEZONE_INIT_ENV="${TIMEZONE_INIT_ENV}"
    export LOCALE_LANG_INIT_ENV="${LOCALE_LANG_INIT_ENV}"
    export STATE_VERSION_INIT_ENV="${STATE_VERSION_INIT_ENV}"

    # Pass through Infisical credentials if they are set
    export INFISICAL_CLIENT_ID_FOR_FLAKE="${INFISICAL_CLIENT_ID}"
    export INFISICAL_CLIENT_SECRET_FOR_FLAKE="${INFISICAL_CLIENT_SECRET}"
    export INFISICAL_ADDRESS_FOR_FLAKE="${INFISICAL_BOOTSTRAP_ADDRESS}"

    # Download and run nixos-everywhere.sh
    curl -L https://raw.githubusercontent.com/evanlhatch/nixos-everywhere/refactor-v3/scripts/nixos_everywhere.sh | bash 2>&1 | tee /var/log/nixos-everywhere.log
